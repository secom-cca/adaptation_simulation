<!DOCTYPE html>
<html>
<head>
    <title>ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .stat { background: #f0f0f0; padding: 20px; margin: 10px; border-radius: 5px; }
        .error { color: red; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .file-list { margin: 20px 0; }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            margin: 5px 0;
            border-radius: 5px;
        }
        .file-info { flex-grow: 1; }
        .file-name { font-weight: bold; }
        .file-details { font-size: 0.9em; color: #666; }
        .download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 10px;
        }
        .download-btn:hover { background: #218838; }
        .download-all-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        .download-all-btn:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
    <button onclick="loadData()">ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°</button>

    <div class="stat">
        <h3>çµ±è¨ˆæƒ…å ±</h3>
        <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: <span id="user-count">--</span></p>
        <p>ãƒ­ã‚°æ•°: <span id="log-count">--</span></p>
        <p>è©•ä¾¡æ•°: <span id="score-count">--</span></p>
        <p>æ±ºå®šæ•°: <span id="decision-count">--</span></p>
    </div>

    <div id="users-section">
        <h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ</h3>
        <div id="users-data">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div id="logs-section">
        <h3>æœ€æ–°ãƒ­ã‚°</h3>
        <div id="logs-data">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div id="files-section">
        <h3>ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«</h3>
        <button class="download-all-btn" onclick="downloadAllData()">ğŸ“¦ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <div id="files-data">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    
    <script>
        const BACKEND_URL = "https://web-production-5fb04.up.railway.app";
        
        async function loadData() {
            console.log("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹...");

            try {
                // ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                try {
                    const dashboardResponse = await fetch(`${BACKEND_URL}/admin/dashboard`, {
                        headers: {
                            'Authorization': 'Basic ' + btoa('admin:climate2025')
                        }
                    });

                    if (dashboardResponse.ok) {
                        const dashboardData = await dashboardResponse.json();
                        console.log("ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿:", dashboardData);

                        // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
                        document.getElementById("user-count").textContent = dashboardData.summary?.total_users || 0;
                        document.getElementById("log-count").textContent = dashboardData.summary?.total_logs || 0;
                        document.getElementById("score-count").textContent = dashboardData.summary?.total_simulations || 0;
                        document.getElementById("decision-count").textContent = "N/A";

                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
                        if (dashboardData.users && Array.isArray(dashboardData.users)) {
                            let usersHtml = "<ul>";
                            dashboardData.users.forEach(user => {
                                usersHtml += `<li>${user}</li>`;
                            });
                            usersHtml += "</ul>";
                            document.getElementById("users-data").innerHTML = usersHtml;
                        } else {
                            document.getElementById("users-data").innerHTML = "<p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãªã—</p>";
                        }

                        // æœ€æ–°ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’è¡¨ç¤º
                        if (dashboardData.recent_activity && Array.isArray(dashboardData.recent_activity)) {
                            let logsHtml = "<table><tr><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th><th>ã‚¿ã‚¤ãƒ—</th><th>æ™‚é–“</th></tr>";
                            dashboardData.recent_activity.slice(0, 10).forEach(log => {
                                logsHtml += `<tr><td>${log.user_name || 'N/A'}</td><td>${log.type || 'N/A'}</td><td>${log.timestamp || 'N/A'}</td></tr>`;
                            });
                            logsHtml += "</table>";
                            document.getElementById("logs-data").innerHTML = logsHtml;
                        } else {
                            document.getElementById("logs-data").innerHTML = "<p>ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ãªã—</p>";
                        }

                    } else {
                        throw new Error(`ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰API ã‚¨ãƒ©ãƒ¼: ${dashboardResponse.status}`);
                    }
                } catch (error) {
                    console.error("ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—:", error);
                    document.getElementById("user-count").textContent = "0";
                    document.getElementById("users-data").innerHTML = `<div class="error">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}</div>`;
                    document.getElementById("logs-data").innerHTML = `<div class="error">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}</div>`;
                }

                // ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—
                await loadDataFiles();

                console.log("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†");

            } catch (error) {
                console.error("å…¨ä½“èª­ã¿è¾¼ã¿å¤±æ•—:", error);
            }
        }

        async function loadDataFiles() {
            try {
                const response = await fetch(`${BACKEND_URL}/admin/data-files`, {
                    headers: {
                        'Authorization': 'Basic ' + btoa('admin:climate2025')
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log("ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿:", data);

                    if (data.files && Array.isArray(data.files)) {
                        let filesHtml = '<div class="file-list">';
                        data.files.forEach(file => {
                            const fileSize = formatFileSize(file.size);
                            const modifiedDate = new Date(file.modified).toLocaleString('ja-JP');

                            filesHtml += `
                                <div class="file-item">
                                    <div class="file-info">
                                        <div class="file-name">${file.name}</div>
                                        <div class="file-details">ã‚µã‚¤ã‚º: ${fileSize} | æ›´æ–°: ${modifiedDate}</div>
                                    </div>
                                    <button class="download-btn" onclick="downloadFile('${file.name}')">
                                        ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                    </button>
                                </div>
                            `;
                        });
                        filesHtml += '</div>';
                        document.getElementById("files-data").innerHTML = filesHtml;
                    } else {
                        document.getElementById("files-data").innerHTML = "<p>ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>";
                    }
                } else {
                    throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆAPI ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                }
            } catch (error) {
                console.error("ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿å¤±æ•—:", error);
                document.getElementById("files-data").innerHTML = `<div class="error">ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}</div>`;
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function downloadFile(filename) {
            const url = `${BACKEND_URL}/admin/download/file/${filename}`;
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;

            // Basicèªè¨¼ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®š
            fetch(url, {
                headers: {
                    'Authorization': 'Basic ' + btoa('admin:climate2025')
                }
            }).then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ${response.status}`);
                }
            }).then(blob => {
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            }).catch(error => {
                console.error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            });
        }

        function downloadAllData() {
            const url = `${BACKEND_URL}/admin/download/all`;

            fetch(url, {
                headers: {
                    'Authorization': 'Basic ' + btoa('admin:climate2025')
                }
            }).then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ${response.status}`);
                }
            }).then(blob => {
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `climate_simulation_data_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            }).catch(error => {
                console.error('å…¨ãƒ‡ãƒ¼ã‚¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                alert(`å…¨ãƒ‡ãƒ¼ã‚¿ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            });
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®
        window.addEventListener("load", loadData);
    </script>
</body>
</html>
