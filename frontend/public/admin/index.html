<!DOCTYPE html>
<html>
<head>
    <title>ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .stat { background: #f0f0f0; padding: 20px; margin: 10px; border-radius: 5px; }
        .error { color: red; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .file-list { margin: 20px 0; }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            margin: 5px 0;
            border-radius: 5px;
        }
        .file-info { flex-grow: 1; }
        .file-name { font-weight: bold; }
        .file-details { font-size: 0.9em; color: #666; }
        .download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 10px;
        }
        .download-btn:hover { background: #218838; }
        .download-all-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        .download-all-btn:hover { background: #0056b3; }
        .clear-data-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 10px 10px 0;
        }
        .clear-data-btn:hover { background: #c82333; }
        .preview-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 5px;
        }
        .preview-btn:hover { background: #138496; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 1000px;
            max-height: 80%;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover { color: black; }
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .preview-table th,
        .preview-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .preview-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        .json-preview {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .text-preview {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        /* ãƒ­ã‚°ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-title {
            font-size: 2rem;
            margin-bottom: 30px;
            color: #333;
            font-weight: bold;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .login-input {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .login-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        .login-error {
            color: #dc3545;
            margin-top: 15px;
            padding: 10px;
            background: #f8d7da;
            border-radius: 5px;
            display: none;
        }

        .admin-content {
            display: none;
        }

        .logout-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }

        .logout-btn:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="login-container" class="login-container">
        <div class="login-box">
            <h1 class="login-title">ğŸ” ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h1>
            <form class="login-form" onsubmit="handleLogin(event)">
                <input
                    type="text"
                    id="username"
                    class="login-input"
                    placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å"
                    required
                    autocomplete="username"
                >
                <input
                    type="password"
                    id="password"
                    class="login-input"
                    placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
                    required
                    autocomplete="current-password"
                >
                <button type="submit" class="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <div id="login-error" class="login-error"></div>
            </form>
        </div>
    </div>

    <!-- ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
    <div id="admin-content" class="admin-content">
        <div class="container">
            <div class="header">
                <h1>ğŸ”§ ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
                <div>
                    <button class="refresh-btn" onclick="loadData()">ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°</button>
                    <button class="logout-btn" onclick="logout()">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-users">--</div>
                    <div class="stat-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-logs">--</div>
                    <div class="stat-label">ãƒ­ã‚°æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-scores">--</div>
                    <div class="stat-label">è©•ä¾¡æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-decisions">--</div>
                    <div class="stat-label">æ±ºå®šæ•°</div>
                </div>
            </div>

            <div class="data-section">
                <h3>ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ</h3>
                <div id="users-container" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>

            <div class="data-section">
                <h3>ğŸ” æœ€æ–°ãƒ­ã‚°</h3>
                <div id="logs-container" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>

            <div class="data-section">
                <h3>ğŸ“ ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«</h3>
                <button class="download-all-btn" onclick="downloadAllData()">ğŸ“¦ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                <button class="clear-data-btn" onclick="clearAllData()">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»</button>
                <div id="files-data">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <span class="close" onclick="closePreviewModal()">&times;</span>
            </div>
            <div id="modalBody">
                <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
        </div>
    </div>
    
    <script>
        const BACKEND_URL = "https://web-production-5fb04.up.railway.app";
        let authCredentials = null;

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã¯å¸¸ã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤º
        window.addEventListener('load', function() {
            // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€æ¯å›ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦
            clearStoredCredentials();
            showLoginForm();
        });

        function clearStoredCredentials() {
            // æ—¢å­˜ã®èªè¨¼æƒ…å ±ã‚’ã‚¯ãƒªã‚¢
            authCredentials = null;
            localStorage.removeItem('adminCredentials');
        }

        function showLoginForm() {
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('admin-content').style.display = 'none';
        }

        function showAdminContent() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('admin-content').style.display = 'block';
        }

        function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');

            // èªè¨¼æƒ…å ±ã‚’ãƒã‚§ãƒƒã‚¯
            if (username === 'admin' && password === 'climate2025') {
                // èªè¨¼æˆåŠŸï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®ã¿æœ‰åŠ¹ã€localStorageä¿å­˜ãªã—ï¼‰
                authCredentials = btoa(`${username}:${password}`);

                errorDiv.style.display = 'none';
                showAdminContent();

                // DOMè¦ç´ ãŒç¢ºå®Ÿã«è¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§å°‘ã—å¾…ã¤
                setTimeout(() => {
                    loadData();
                }, 100);
            } else {
                // èªè¨¼å¤±æ•—
                errorDiv.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
                errorDiv.style.display = 'block';

                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('password').value = '';
            }
        }

        function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                // èªè¨¼æƒ…å ±ã‚’ã‚¯ãƒªã‚¢
                authCredentials = null;
                showLoginForm();

                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            }
        }

        async function loadData() {
            if (!authCredentials) {
                alert('èªè¨¼ãŒå¿…è¦ã§ã™ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                showLoginForm();
                return;
            }
            console.log("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹...");

            try {
                // ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                try {
                    const dashboardResponse = await fetch(`${BACKEND_URL}/admin/dashboard`, {
                        headers: {
                            'Authorization': 'Basic ' + authCredentials
                        }
                    });

                    if (dashboardResponse.ok) {
                        const dashboardData = await dashboardResponse.json();
                        console.log("ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿:", dashboardData);

                        // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
                        document.getElementById("total-users").textContent = dashboardData.summary?.total_users || 0;
                        document.getElementById("total-logs").textContent = dashboardData.summary?.total_logs || 0;
                        document.getElementById("total-scores").textContent = dashboardData.summary?.total_simulations || 0;
                        document.getElementById("total-decisions").textContent = "N/A";

                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
                        if (dashboardData.users && Array.isArray(dashboardData.users)) {
                            let usersHtml = "<ul>";
                            dashboardData.users.forEach(user => {
                                usersHtml += `<li>${user}</li>`;
                            });
                            usersHtml += "</ul>";
                            document.getElementById("users-container").innerHTML = usersHtml;
                        } else {
                            document.getElementById("users-container").innerHTML = "<p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãªã—</p>";
                        }

                        // æœ€æ–°ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’è¡¨ç¤º
                        if (dashboardData.recent_activity && Array.isArray(dashboardData.recent_activity)) {
                            let logsHtml = "<table><tr><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th><th>ã‚¿ã‚¤ãƒ—</th><th>æ™‚é–“</th></tr>";
                            dashboardData.recent_activity.slice(0, 10).forEach(log => {
                                logsHtml += `<tr><td>${log.user_name || 'N/A'}</td><td>${log.type || 'N/A'}</td><td>${log.timestamp || 'N/A'}</td></tr>`;
                            });
                            logsHtml += "</table>";
                            document.getElementById("logs-container").innerHTML = logsHtml;
                        } else {
                            document.getElementById("logs-container").innerHTML = "<p>ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ãªã—</p>";
                        }

                    } else {
                        throw new Error(`ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰API ã‚¨ãƒ©ãƒ¼: ${dashboardResponse.status}`);
                    }
                } catch (error) {
                    console.error("ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—:", error);
                    document.getElementById("total-users").textContent = "0";
                    document.getElementById("users-container").innerHTML = `<div class="error">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}</div>`;
                    document.getElementById("logs-container").innerHTML = `<div class="error">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}</div>`;
                }

                // ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—
                await loadDataFiles();

                console.log("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†");

            } catch (error) {
                console.error("å…¨ä½“èª­ã¿è¾¼ã¿å¤±æ•—:", error);
            }
        }

        async function loadDataFiles() {
            try {
                const response = await fetch(`${BACKEND_URL}/admin/data-files`, {
                    headers: {
                        'Authorization': 'Basic ' + authCredentials
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log("ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿:", data);

                    if (data.files && Array.isArray(data.files)) {
                        let filesHtml = '<div class="file-list">';
                        data.files.forEach(file => {
                            const fileSize = formatFileSize(file.size);
                            const modifiedDate = new Date(file.modified).toLocaleString('ja-JP');

                            filesHtml += `
                                <div class="file-item">
                                    <div class="file-info">
                                        <div class="file-name">${file.name}</div>
                                        <div class="file-details">ã‚µã‚¤ã‚º: ${fileSize} | æ›´æ–°: ${modifiedDate}</div>
                                    </div>
                                    <div>
                                        <button class="preview-btn" onclick="previewFile('${file.name}')">
                                            ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                                        </button>
                                        <button class="download-btn" onclick="downloadFile('${file.name}')">
                                            ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                        filesHtml += '</div>';
                        document.getElementById("files-data").innerHTML = filesHtml;
                    } else {
                        document.getElementById("files-data").innerHTML = "<p>ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>";
                    }
                } else {
                    throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆAPI ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                }
            } catch (error) {
                console.error("ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿å¤±æ•—:", error);
                document.getElementById("files-data").innerHTML = `<div class="error">ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}</div>`;
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function downloadFile(filename) {
            if (!authCredentials) {
                alert('èªè¨¼ãŒå¿…è¦ã§ã™ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                showLoginForm();
                return;
            }

            const url = `${BACKEND_URL}/admin/download/file/${filename}`;
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;

            // Basicèªè¨¼ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®š
            fetch(url, {
                headers: {
                    'Authorization': 'Basic ' + authCredentials
                }
            }).then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ${response.status}`);
                }
            }).then(blob => {
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            }).catch(error => {
                console.error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            });
        }

        function downloadAllData() {
            if (!authCredentials) {
                alert('èªè¨¼ãŒå¿…è¦ã§ã™ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                showLoginForm();
                return;
            }

            const url = `${BACKEND_URL}/admin/download/all`;

            fetch(url, {
                headers: {
                    'Authorization': 'Basic ' + authCredentials
                }
            }).then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ${response.status}`);
                }
            }).then(blob => {
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `climate_simulation_data_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            }).catch(error => {
                console.error('å…¨ãƒ‡ãƒ¼ã‚¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                alert(`å…¨ãƒ‡ãƒ¼ã‚¿ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            });
        }

        function previewFile(filename) {
            if (!authCredentials) {
                alert('èªè¨¼ãŒå¿…è¦ã§ã™ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                showLoginForm();
                return;
            }

            const url = `${BACKEND_URL}/admin/preview-file/${filename}`;

            fetch(url, {
                headers: {
                    'Authorization': 'Basic ' + authCredentials
                }
            }).then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å¤±æ•—: ${response.status}`);
                }
            }).then(data => {
                showPreviewModal(data);
            }).catch(error => {
                console.error('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
                alert(`ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            });
        }

        function showPreviewModal(data) {
            const modal = document.getElementById('previewModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modalTitle.textContent = `${data.filename} - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼`;

            let content = '';

            if (data.type === 'table') {
                // ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§è¡¨ç¤º
                content = `
                    <p><strong>ç·è¡Œæ•°:</strong> ${data.total_rows} è¡Œ (æœ€åˆã®100è¡Œã‚’è¡¨ç¤º)</p>
                    <div style="overflow-x: auto;">
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    ${data.columns.map(col => `<th>${col}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.map(row => `
                                    <tr>
                                        ${data.columns.map(col => `<td title="${row[col] || ''}">${row[col] || ''}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (data.type === 'json') {
                // JSONå½¢å¼ã§è¡¨ç¤º
                content = `
                    <p><strong>ç·è¡Œæ•°:</strong> ${data.total_rows} è¡Œ (æœ€åˆã®100è¡Œã‚’è¡¨ç¤º)</p>
                    <div class="json-preview">${JSON.stringify(data.data, null, 2)}</div>
                `;
            } else if (data.type === 'text') {
                // ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§è¡¨ç¤º
                content = `
                    <p><strong>ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º:</strong> ${data.total_size ? formatFileSize(data.total_size) : 'N/A'}</p>
                    ${data.error ? `<p style="color: red;"><strong>æ³¨æ„:</strong> ${data.error}</p>` : ''}
                    <div class="text-preview">${data.data}</div>
                `;
            } else if (data.type === 'error') {
                // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
                content = `
                    <p style="color: red;"><strong>ã‚¨ãƒ©ãƒ¼:</strong> ${data.message}</p>
                `;
            }

            modalBody.innerHTML = content;
            modal.style.display = 'block';
        }

        function closePreviewModal() {
            document.getElementById('previewModal').style.display = 'none';
        }

        function clearAllData() {
            if (!authCredentials) {
                alert('èªè¨¼ãŒå¿…è¦ã§ã™ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                showLoginForm();
                return;
            }

            if (!confirm('âš ï¸ è­¦å‘Š: å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ãŒæ¶ˆå»ã•ã‚Œã¾ã™ã€‚\n\nãƒ•ã‚¡ã‚¤ãƒ«è‡ªä½“ã¯æ®‹ã‚Šã¾ã™ãŒã€ä¸­èº«ã¯ç©ºã«ãªã‚Šã¾ã™ã€‚\nãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ãªã©ã«ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚\n\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            if (!confirm('æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }

            const url = `${BACKEND_URL}/admin/clear-data`;

            fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': 'Basic ' + authCredentials,
                    'Content-Type': 'application/json'
                }
            }).then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`ãƒ‡ãƒ¼ã‚¿æ¶ˆå»å¤±æ•—: ${response.status}`);
                }
            }).then(result => {
                alert(`ãƒ‡ãƒ¼ã‚¿æ¶ˆå»å®Œäº†ï¼\n\nå‡¦ç†ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${result.total_files_processed}\næˆåŠŸ: ${result.successful_clears}\nã‚¨ãƒ©ãƒ¼: ${result.errors ? result.errors.length : 0}`);
                // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                loadData();
            }).catch(error => {
                console.error('ãƒ‡ãƒ¼ã‚¿æ¶ˆå»ã‚¨ãƒ©ãƒ¼:', error);
                alert(`ãƒ‡ãƒ¼ã‚¿æ¶ˆå»ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            });
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
        window.onclick = function(event) {
            const modal = document.getElementById('previewModal');
            if (event.target === modal) {
                closePreviewModal();
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†ã¯ checkLoginStatus() ã§è¡Œã†
    </script>
</body>
</html>
